\usepackage[american]{babel}
\usepackage{csquotes}
\usepackage[%maxcitenames=2,
  sorting=centy,hyperref=true,backend=biber]{biblatex-chicago}
\input{Asian.tex}

\DeclareCiteCommand{\cite}
  {\usebibmacro{prenote}}
  {\usedriver
     {\DeclareNameAlias{sortname}{default}}
     {cite:\thefield{entrytype}}} % 這句是關鍵
  {\multicitedelim}
  {\usebibmacro{postnote}}
\newcommand{\ccite}[1]{\footnote{\ttfamily \cite{#1}。}}
\newcommand{\ecite}[1]{\footnote{\ttfamily \cite{#1}.}}
\newcommand{\fcite}[3]{\footnote{\ttfamily {#1}\cite{#2}{#3}}}
\newcommand{\ftnote}[1]{\footnote{\ttfamily {#1}}}

%定義古籍
\defbibfilter{hsource}{%
\( \subtype{商} \or \subtype{周} \or \subtype{春秋} \or \subtype{戰國} \or \subtype{秦} \or \subtype{漢} \or \subtype{三國} \or \subtype{晉} \or \subtype{北魏} \or \subtype{東魏} \or \subtype{西魏} \or \subtype{北齊} \or \subtype{北周} \or \subtype{南朝宋} \or \subtype{南朝齊} \or \subtype{南朝梁} \or \subtype{南朝陳} \or \subtype{隋} \or \subtype{唐} \or \subtype{五代} \or \subtype{宋} \or \subtype{元} \or \subtype{明} \or \subtype{淸} \or \subtype{日} \or \keyword{古籍} \)
}
\defbibfilter{nothsource}{%
\( not \subtype{商} \and \not \subtype{周} \and \not \subtype{春秋} \and \not \subtype{戰國} \and \not \subtype{秦} \and \not \subtype{漢} \and \not \subtype{三國} \and \not \subtype{晉} \and \not \subtype{北魏} \and \not \subtype{東魏} \and \not \subtype{西魏} \and \not \subtype{北齊} \and \not \subtype{北周} \and \not \subtype{南朝宋} \and \not \subtype{南朝齊} \and \not \subtype{南朝梁} \and \not \subtype{南朝陳} \and \not \subtype{隋} \and \not \subtype{唐} \and \not \subtype{五代} \and \not \subtype{宋} \and \not \subtype{元} \and \not \subtype{明} \and \not \subtype{淸} \and \not \subtype{日} \and \not \keyword{古籍} \)
}

\DeclareFieldFormat[article,thesis,inbook,inproceedings,online,unpublished]{title}{\cearticle{#1}}
\DeclareFieldFormat[incollection,book,misc,ancient]{title}{\cebook{#1}}
\DeclareFieldFormat{journaltitle}{\cebook{#1}}

\newbibmacro*{bibprefix}{\printfield{addendum}}
\newbibmacro*{dynasty}{%
  \iffieldundef{entrysubtype}{}{%
    ［\printfield{entrysubtype}］}}
\newbibmacro*{cevol}{%
  \iffieldundef{volume}{}{%
    \cegen{第}{Vol. }%
    \printfield{volume}%
    \cegen{卷}{\addcomma\addspace}%
  }}
\newbibmacro*{ceseries}{%
  \iffieldundef{series}{}{%
    \cegen{第}{ser.}%
    \printfield[noformat]{series}%
    \cegen{輯}{\addcomma\addspace}%
  }}
\newbibmacro*{cenum}{%
  \iffieldundef{number}{}{%
    \cegen{第}{No. }%
    \printfield{number}%
    \cegen{期}{}%
  }}
\newbibmacro*{volumes}{%
  \iffieldundef{volumes}{}{%
    \printfield{volumes}%
  }}
\newbibmacro*{pages}{%
  \iffieldundef{pages}{}{%
    \cecomma\setunit{}\cegen{頁}{pp. }\printfield{pages}}}%
\renewbibmacro*{urldate}{\thefield{urlyear}\bibrangedash\thefield{urlmonth}\bibrangedash\thefield{urlday}}
\newbibmacro*{book-title}{%
  \printtext[title]{%
    \printfield[noformat]{title}%
    \setunit{\cecolon}%
    \printfield[noformat]{subtitle}}%
}
\newbibmacro*{article-title}{%
  \printtext[title]{%
    \printfield[noformat]{title}%
    \setunit{\cecolon}%
    \printfield[noformat]{subtitle}}%
  \setunit{\cecomma}%
}
\newbibmacro*{loc+inst+type+year}{%
  \printlist{location}%
  \setunit*{\cecolon}%
  \printlist{institution}%
  \printfield{type}%
  \setunit*{\cecomma}%
  \printfield{year}%
}

\renewbibmacro*{publ+loc+year}{%
  \printlist{location}%
  \iflistundef{publisher}%
  {\setunit*{\cecomma}}%
  {\setunit*{\cecolon}}%
  \printlist{publisher}%
  \setunit*{\cecomma}%
  \usebibmacro{date}%
}

\renewbibmacro*{byauthor}{%
  \ifthenelse{\ifuseauthor\OR
              \ifnameundef{author}}
    {}
    {\bibstring{by}\addspace
     \printnames[byauthor]{author}}}

\newbibmacro*{editor+booktitle}{%
  \cegen{收入}{In }%
  \setunit*{}%
  \ifnameundef{editor}{氏著}{%
    \printnames{editor}%
    \cegen{編}{Ed. }%
  }%
  \setunit*{}%
  \cebook{\printfield{booktitle}}%
}


% 王汎森，〈明末清初儒學的宗教化：以許三禮的告天之學為例〉，《新史學》第 9 卷第 2 期，1998，臺北，頁 89-123。
\DeclareBibliographyDriver{article}{%
  \usebibmacro{bibindex}%
  \usebibmacro{mag+news+author}%
  \newcunit\newblock%
  \usebibmacro{article-title}%
  \usebibmacro{journal+sub}%
  \cegen{}{\addcomma\addspace}%
  \setunit*{}%
  \usebibmacro{cevol}%
  \usebibmacro{cenum}%
  \usebibmacro{ceseries}%
  \newcunit\newblock%
  \usebibmacro{date}%
  \newcunit\newblock%
  \printlist{location}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}
%王汎森，〈明末清初儒學的宗教化：以許三禮的告天之學為例〉，《新史學》第9卷第2期（1998，臺北），頁89-123。
\DeclareBibliographyDriver{cite:article}{%
  \usebibmacro{mag+news+author}%
  \newcunit\newblock%
  \usebibmacro{article-title}%
  \usebibmacro{journal+sub}%
  \cegen{}{\addcomma\addspace}%
  \setunit*{}%
  \usebibmacro{cevol}%
  \usebibmacro{cenum}%
  \usebibmacro{ceseries}%
  \cegen{}{\addspace}%
  \setunit*{}%
  \cebracket{\usebibmacro{date}\cecomma\printlist{location}}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

%朱漢民，《中國的書院》。臺北：臺灣商務印書館，1993。
\DeclareBibliographyDriver{book}{%
  \usebibmacro{bibindex}%
  \printfield{bibprefix}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \setunit{\ceperiod}%
  \usebibmacro{publ+loc+year}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}
%朱漢民，《中國的書院》（臺北：臺灣商務印書館，1993），頁110-111。
\DeclareBibliographyDriver{cite:book}{%
  \usebibmacro{bibindex}%
  \printfield{bibprefix}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \cegen{}{\addspace}%
  \setunit*{}%
  \cebracket{\usebibmacro{publ+loc+year}}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

%于振波，〈漢代的循吏與酷吏〉，收入氏著，《簡牘與秦漢社會》，頁282-295。長沙：湖南大學出版社，2012。
\DeclareBibliographyDriver{inbook}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{article-title}\cecomma%
  \usebibmacro{editor+booktitle}%
  \usebibmacro{pages}%
  \setunit{\ceperiod}%
  \usebibmacro{publ+loc+year}%
  \usebibmacro{finentry}%
}
%于振波，〈漢代的循吏與酷吏〉，收入氏著，《簡牘與秦漢社會》（長沙：湖南大學出版社，2012），頁282。
\DeclareBibliographyDriver{cite:inbook}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{article-title}\cecomma%
  \usebibmacro{editor+booktitle}%
  \cebracket{\usebibmacro{publ+loc+year}}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

%朱鴻，〈明成祖與永樂政治〉。臺北：國立臺灣師範大學歷史研究所博士論文，1982。
\DeclareBibliographyDriver{thesis}{%
  \usebibmacro{bibindex}%
  \usebibmacro{author/editor}%
  \setunit*{}%
  \printfield{nameaddon}%
  \newcunit\newblock%
  \ifundef\lasthash{\usebibmacro{book-title}\setunit{\ceperiod}}{}%
  \ifundef\lasthash{}{\usebibmacro{book-title}\setunit{\ceperiod}}%
  \newunit%
  \usebibmacro{loc+inst+type+year}%
  \usebibmacro{finentry}
}
%朱鴻，〈明成祖與永樂政治〉（臺北：國立臺灣師範大學歷史研究所博士論文，1982）。
\DeclareBibliographyDriver{cite:thesis}{%
  \usebibmacro{bibindex}%
  \usebibmacro{author/editor}%
  \setunit*{}%
  \printfield{nameaddon}%
  \newcunit\newblock%
  \ifundef\lasthash{\usebibmacro{book-title}}{}%
  \ifundef\lasthash{}{\usebibmacro{book-title}}%
  \setunit*{\cegen{}{\addspace}}%
  \cebracket{%
    \usebibmacro{loc+inst+type+year}%
  }%
  \usebibmacro{finentry}
}

\DeclareBibliographyDriver{online}{%
  \usebibmacro{bibindex}%
  \usebibmacro{author/editor}%
  \setunit{\addspace}%
  \printfield{nameaddon}%
  \newcunit\newblock%
  \usebibmacro{article-title}\ceperiod\setunit{\addspace}%
  \newunit\newblock%
  \cegen{擷取日期}{Accessed }%
  \usebibmacro{urldate}%
  \ceperiod\setunit{\addspace}%
  \usebibmacro{url}%
  \usebibmacro{finentry}%
}

\DeclareBibliographyDriver{cite:online}{%
  \usebibmacro{bibindex}%
  \usebibmacro{author/editor}%
  \setunit{\addspace}%
  \printfield{nameaddon}%
  \newcunit\newblock%
  \usebibmacro{article-title}\ceperiod\setunit{\addspace}%
  \newunit\newblock%
  \cegen{擷取日期}{Accessed }%
  \usebibmacro{urldate}%
  \ceperiod\setunit{\addspace}%
  \usebibmacro{url}%
  \usebibmacro{finentry}%
}

\DeclareBibliographyDriver{ancient}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \setunit{\ceperiod}%
  \usebibmacro{publ+loc+year}%
  \cegen{年}{\addspace}%
  \printfield[noformat]{version}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}
%王鳴盛，《十七史商榷》（臺北：樂天，1972年影廣雅書局本），卷12，頁1。
\DeclareBibliographyDriver{cite:ancient}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \cegen{}{\addspace}%
  \setunit*{}%
  \cebracket{%
    \usebibmacro{publ+loc+year}%
    \cegen{年}{\addspace}%
    \printfield[noformat]{version}%
  }%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

%［明］尤時熙，《尤西川先生擬學小記》，收入《四庫全書存目叢書》子部第9冊。臺南：莊嚴文化公司，1995。
\DeclareBibliographyDriver{incollection}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \newcunit\newblock%
  \setunit*{\cegen{，收入}{, In\addspace}}%
  \printfield[title]{booktitle}%
  \iffieldundef{booksubtitle}{}{\printfield{booksubtitle}}%
  \iffieldundef{publisher}{\ceperiod\usebibmacro{publ+loc+year}}{}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}
%［明］尤時熙，《尤西川先生擬學小記》，收入《四庫全書存目叢書》子部第9冊（臺南：莊嚴文化公司，1995）
\DeclareBibliographyDriver{cite:incollection}{%
  \usebibmacro{bibindex}%
  \usebibmacro{dynasty}%
  \usebibmacro{author/editor}%
  \newcunit\newblock%
  \usebibmacro{book-title}%
  \newcunit\newblock%
  \setunit*{\cegen{，收入}{, In\addspace}}%
  \printfield[title]{booktitle}%
  \iffieldundef{booksubtitle}{}{\printfield{booksubtitle}}%
  \iffieldundef{publisher}{\cebracket{\usebibmacro{publ+loc+year}}}{}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

\DeclareBibliographyDriver{unpublished}{%
  \usebibmacro{bibindex}%
  \usebibmacro{mag+news+author}%
  \newcunit\newblock%
  \usebibmacro{article-title}%
  \printfield{note}%
  \cegen{}{\addcomma\addspace}%
  \setunit*{}%
  \usebibmacro{cevol}%
  \usebibmacro{cenum}%
  \usebibmacro{ceseries}%
  \newcunit\newblock%
  \usebibmacro{date}%
  \newcunit\newblock%
  \printlist{location}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}

\DeclareBibliographyDriver{cite:unpublished}{%
  \usebibmacro{mag+news+author}%
  \newcunit\newblock%
  \usebibmacro{article-title}%
  \printfield{note}%
  \cegen{}{\addcomma\addspace}%
  \setunit*{}%
  \usebibmacro{cevol}%
  \usebibmacro{cenum}%
  \usebibmacro{ceseries}%
  \cegen{}{\addspace}%
  \setunit*{}%
  \cebracket{\usebibmacro{date}\cecomma\printlist{location}}%
  \usebibmacro{pages}%
  \usebibmacro{finentry}%
}
